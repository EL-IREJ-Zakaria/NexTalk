rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // RÈGLES POUR DÉVELOPPEMENT (PERMISSIF)
    // À utiliser pendant le développement/test
    // ==========================================
    
    // Décommentez cette section pour le développement :
    /*
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
    */
    
    // ==========================================
    // RÈGLES POUR PRODUCTION (SÉCURISÉ)
    // À utiliser en production
    // ==========================================
    
    // Collection des utilisateurs
    match /users/{userId} {
      // Tout le monde peut lire les profils publics
      allow read: if request.auth != null;
      
      // Un utilisateur peut modifier uniquement son propre profil
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Collection des conversations
    match /conversations/{conversationId} {
      // Fonction helper pour vérifier si l'utilisateur fait partie de la conversation
      function isParticipant() {
        return request.auth != null && 
               request.auth.uid in resource.data.users;
      }
      
      function isParticipantOnCreate() {
        return request.auth != null && 
               request.auth.uid in request.resource.data.users;
      }
      
      // Lecture : uniquement si l'utilisateur fait partie de la conversation
      allow read: if request.auth != null && 
                    request.auth.uid in resource.data.users;
      
      // Création : uniquement si l'utilisateur fait partie de la nouvelle conversation
      allow create: if isParticipantOnCreate();
      
      // Modification : uniquement si l'utilisateur fait partie de la conversation
      // (pour mettre à jour lastMessage, lastMessageTime, etc.)
      allow update: if isParticipant();
      
      // Messages dans une conversation
      match /messages/{messageId} {
        // Fonction pour vérifier si l'utilisateur fait partie de la conversation parente
        function isConversationParticipant() {
          return request.auth != null && 
                 request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.users;
        }
        
        // Lecture : si fait partie de la conversation
        allow read: if isConversationParticipant();
        
        // Création : si fait partie de la conversation et que le senderId correspond
        allow create: if isConversationParticipant() &&
                        request.resource.data.senderId == request.auth.uid;
        
        // Modification : uniquement ses propres messages (pour les réactions, édition, etc.)
        allow update: if isConversationParticipant();
        
        // Suppression : uniquement ses propres messages
        allow delete: if request.auth != null && 
                        resource.data.senderId == request.auth.uid;
      }
    }
    
    // Collection des statuts (stories)
    match /statuses/{statusId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if request.auth != null;
      
      // Création : tout utilisateur authentifié
      allow create: if request.auth != null && 
                      request.resource.data.userId == request.auth.uid;
      
      // Modification/Suppression : uniquement le créateur
      allow update, delete: if request.auth != null && 
                               resource.data.userId == request.auth.uid;
    }
    
    // Collection des appels
    match /calls/{callId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if request.auth != null;
      
      // Écriture : tous les utilisateurs authentifiés
      // (car l'appelant et le destinataire doivent pouvoir modifier le statut)
      allow write: if request.auth != null;
    }
    
    // Collection des notifications
    match /notifications/{notificationId} {
      // Lecture : uniquement le destinataire
      allow read: if request.auth != null && 
                    resource.data.userId == request.auth.uid;
      
      // Création : tout le monde peut créer des notifications
      allow create: if request.auth != null;
      
      // Modification/Suppression : uniquement le destinataire
      allow update, delete: if request.auth != null && 
                               resource.data.userId == request.auth.uid;
    }
  }
}
